<template>
  <LayoutAuth
    :name="'H·ªì s∆° c·ªßa t√¥i'"
    :loading="loading"
    :breadcrumb="breadcrumb"
  >
    <form class="row gy-1 gx-3">
      <div class="col-12 col-md-6">
        <label for="name" class="form-label">
          <small>H·ªç v√† t√™n</small>
        </label>
        <input
          type="text"
          class="form-control"
          required
          readonly
          :value="detailUser?.data?.ten_kh"
          id="name"
          placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß c·ªßa b·∫°n"
        />
      </div>

      <div class="col-12 col-md-6">
        <label for="businessName" class="form-label">
          <small>T√™n c∆° s·ªü</small>
        </label>
        <input
          type="text"
          class="form-control"
          required
          readonly
          :value="detailUser?.data?.co_so"
          id="businessName"
          placeholder="Nh·∫≠p t√™n c∆° s·ªü ƒëang kinh doanh"
        />
      </div>

      <div class="col-12 col-md-6">
        <label for="phone" class="form-label">
          <small>S·ªë ƒëi·ªán tho·∫°i</small>
        </label>
        <input
          type="phone"
          class="form-control"
          required
          :value="detailUser?.data?.dien_thoai"
          readonly
          id="phone"
          placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
        />
      </div>
      <div class="col-12 col-md-6">
        <label for="ten_thanh_pho" class="form-label">
          <small>Th√†nh ph·ªë</small>
        </label>
        <input
          type="text"
          class="form-control"
          required
          readonly
          :value="detailUser?.data?.ten_thanh_pho"
          id="ten_thanh_pho"
          placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"
        />
      </div>
      <div class="col-12 col-md-6">
        <label for="ten_xa_phuong" class="form-label">
          <small>X√£ ph∆∞·ªùng</small>
        </label>
        <input
          type="text"
          class="form-control"
          required
          readonly
          :value="detailUser?.data?.ten_xa_phuong"
          id="ten_xa_phuong"
          placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"
        />
      </div>
      <div class="col-12 col-md-6">
        <label for="address" class="form-label">
          <small>ƒê·ªãa ch·ªâ</small>
        </label>
        <input
          type="text"
          class="form-control"
          required
          readonly
          :value="detailUser?.data?.dia_chi"
          id="address"
          placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"
        />
      </div>
    </form>
    <!-- Gi·∫•y t·ªù li√™n quan -->
    <div class="row justify-content-center mt-2 g-3">
      <div class="col-6 col-md-4">
        <label for="file1" class="form-label">
          <small>Ch·ª©ng ch·ªâ h√†nh ngh·ªÅ d∆∞·ª£c</small>
        </label>
        <div class="ratio ratio-1x1 img-thumbnail overflow-hidden">
          <img
            v-if="urlGiayTo['url_giay_to1']"
            :src="urlGiayTo['url_giay_to1']"
            alt="Ch·ª©ng ch·ªâ h√†nh ngh·ªÅ d∆∞·ª£c"
          />
          <div
            v-else
            class="d-flex justify-content-center align-items-center bg-light text-muted"
          >
            <small class="text-center px-2">Ch∆∞a c·∫≠p nh·∫≠t</small>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <label for="file2" class="form-label">
          <small>Ch·ª©ng nh·∫≠n ƒëƒÉng k√Ω kinh doanh</small>
        </label>
        <div class="ratio ratio-1x1 img-thumbnail overflow-hidden">
          <img
            v-if="urlGiayTo['url_giay_to2']"
            :src="urlGiayTo['url_giay_to2']"
            alt="Ch·ª©ng nh·∫≠n ƒëƒÉng k√Ω kinh doanh"
          />
          <div
            v-else
            class="d-flex justify-content-center align-items-center bg-light text-muted"
          >
            <small class="text-center px-2">Ch∆∞a c·∫≠p nh·∫≠t</small>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <label for="file3" class="form-label">
          <small>Ch·ª©ng nh·∫≠n ƒë·ªß ƒëi·ªÅu ki·ªán kinh doanh d∆∞·ª£c</small>
        </label>
        <div class="ratio ratio-1x1 img-thumbnail overflow-hidden">
          <img
            v-if="urlGiayTo['url_giay_to3']"
            :src="urlGiayTo['url_giay_to3']"
            alt="Ch·ª©ng nh·∫≠n ƒë·ªß ƒëi·ªÅu ki·ªán kinh doanh d∆∞·ª£c"
          />
          <div
            v-else
            class="d-flex justify-content-center align-items-center bg-light text-muted"
          >
            <small class="text-center px-2">Ch∆∞a c·∫≠p nh·∫≠t</small>
          </div>
        </div>
      </div>
    </div>
    <h6 class="my-3 fw-bold pb-2 d-inline-block text-capitalize">
      Nh√≥m Thu·ªëc ƒê∆∞·ª£c ph√©p Kinh Doanh
    </h6>
    <div class="row gy-2 gx-3">
      <div
        v-for="(item, colIndex) in medicineGroups"
        :key="colIndex"
        class="col-12 col-md-4"
      >
        <div class="d-flex gap-2">
          <SquareCheck
            v-if="item?.checked"
            class="flex-shrink-0 text-white bg-primary"
          />
          <Square class="flex-shrink-0 text-muted" v-else />
          <small class="form-check-label" :for="item?.ma_nh">
            {{ item?.ten_nh }}
          </small>
        </div>
      </div>
    </div>
  </LayoutAuth>
</template>

<script lang="ts" setup>
interface NhomThuocKinhDoanh {
  ma_nh: string;
  ten_nh: string;
  checked?: boolean;
}
import type { ProjectConfig } from "~/model";
import type {
  CustomerDetail,
  CustomerResponse,
} from "~/model/customer/Customer";
definePageMeta({
  middleware: "auth",
});

const { $appServices } = useNuxtApp();

const urlGiayTo = ref<Record<string, string>>({
  url_giay_to1: "",
  url_giay_to2: "",
  url_giay_to3: "",
});

const breadcrumb = ref<Array<ProjectConfig.BreadcrumbItem>>([
  { label: "T√†i kho·∫£n", to: "/auth" },
  { label: "H·ªì s∆° kh√°ch h√†ng" },
]);
const loading = ref(false);
const detailUser = ref<CustomerResponse | null>(null);

// Danh s√°ch nh√≥m thu·ªëc kinh doanh ƒë∆∞·ª£c t·ªï ch·ª©c th√†nh 3 c·ªôt
const medicineGroups = ref<Array<NhomThuocKinhDoanh>>();

async function getDetailUser() {
  loading.value = true;
  try {
    const response = await $appServices.customer.detail();
    detailUser.value = response.data as CustomerResponse;
    const nhom_thuoc_kinh_doanh = response.data.nhoms || [];
    console.log("üöÄ ~ getDetailUser ~ response:", response);
    getGiayToData("url_giay_to1", response.data.data.url_giay_to1);
    getGiayToData("url_giay_to2", response.data.data.url_giay_to2);
    getGiayToData("url_giay_to3", response.data.data.url_giay_to3);
    medicineGroups.value?.forEach((group) => {
      group.checked = nhom_thuoc_kinh_doanh
        .map((item: NhomThuocKinhDoanh) => item.ma_nh)
        .includes(group.ma_nh);
    });
  } catch (error) {
  } finally {
    loading.value = false;
  }
}

$appServices.items.getNhomThuocKinhDoanh<NhomThuocKinhDoanh>().then((resp) => {
  medicineGroups.value = resp.getData;
});

onMounted(() => {
  getDetailUser();
});
onUpdated(() => {
  if (urlGiayTo.value["url_giay_to1"]) {
    URL.revokeObjectURL(urlGiayTo.value["url_giay_to1"]);
  }
  if (urlGiayTo.value["url_giay_to2"]) {
    URL.revokeObjectURL(urlGiayTo.value["url_giay_to2"]);
  }
  if (urlGiayTo.value["url_giay_to3"]) {
    URL.revokeObjectURL(urlGiayTo.value["url_giay_to3"]);
  }
});

async function getGiayToData(key: string, url?: string) {
  if (!url) return;
  try {
    const response = await $appServices.file.getFileBlob(url);
    const urlBlob = URL.createObjectURL(response as Blob);
    urlGiayTo.value[key] = urlBlob;
  } catch (error) {
    console.error("Error fetching file blob:", error);
  }
}
</script>

<style scoped>
.sticky-top {
  top: 80px;
  z-index: 0 !important;
}
</style>
